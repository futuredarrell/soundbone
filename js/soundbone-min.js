(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o="createTouch"in document?"touchstart":"click",p="createTouch"in document?!0:!1;window.soundbone=a={},g=Backbone.View.extend({initialize:function(){var a=this;a.screens=[],a.createScreen(),a.currentView=null,a.stream=[5968824,4456728,291],a.tracks=new b,a.header=new m,a.settings={autoplay:!0},_.each(a.stream,function(b,d){a.tracks.add(new c({id:b}))})},transitionTo:function(a,b){var c=$(window).width(),d=this,e=d.header,f="";b=b||1,f=b===1?"-100%":"100%";if(!d.currentView)return d.currentView=a,a.render(),$(e.el).appendTo(d.currentScreen()),e.update(a),$(a.el).appendTo(d.currentScreen()),!1;$(d.currentScreen()).css({width:c,position:"absolute",top:0,left:0,overflow:"hidden"});var g=$(d.createScreen()).css({width:c,display:"block",position:"absolute",top:0,left:c*b,overflow:"hidden"});a.rendered||a.render(),e=new m,e.update(a),$(e.el).appendTo(g),$(g).append(a.el),$("#container").css({width:c,"-webkit-transform":"translate3d("+f+",0,0)","-webkit-transition":"-webkit-transform .5s ease-out"}),$("#container").bind("webkitTransitionEnd",function(b){if(b.srcElement===$("#container")[0]){var c=$("#container")[0];c.removeChild(c.childNodes[0]),$("#container").attr("style",""),$(".screen").attr("style",""),$("#container").unbind("webkitTransitionEnd"),d.screens=d.screens.slice(0,1),a.trigger("transitionEnd"),delete d.currentView,d.currentView=a}})},createScreen:function(a){var b;return b=$('<div class="screen">').appendTo("#container")[0],this.screens.push(b),b},currentScreen:function(){return this.screens[0]}}),i=Backbone.Router.extend({routes:{"":"stream","tracks/:id":"track"},stream:function(){h.home=h.home||new k({collection:h.tracks}),h.transitionTo(h.home)},track:function(a){var b=h.tracks.get({id:a}),c=h.tracks.models.indexOf(b),d,e=1;h.trackDetail&&(d=h.tracks.models.indexOf(h.trackDetail.model),d>c&&(e=-1),delete h.trackDetail),h.trackDetail=new l({model:b}),h.transitionTo(h.trackDetail,e)}}),c=Backbone.Model.extend({localStorage:new Store("tracks"),initialize:function(){this.set({selected:!1});var a=this;this.localStorage.find(this)?(this.set(this.localStorage.find(this)),this.set({loaded:!0})):SC.get("/tracks/"+a.id,function(b,c){c&&console.log("ERROR: ",c),a.set(b),a.save(),a.trigger("loaded"),a.set({loaded:!0})})},play:function(){var a=this.collection;a.currentTrack&&a.currentTrack.destruct(),a.currentTrack=this;var b=this.load();b.play(),this.set({selected:!0})},pause:function(){this.stream.togglePause()},load:function(){var a=this;return this.stream&&this.stream.playState===1?this.stream:this.stream=SC.stream(this.id,{onplay:function(){this.onposition(100,function(){a.trigger("play")})},onfinish:function(){a.collection.select("next"),a.trigger("finish"),a.destruct()},onpause:function(){a.trigger("pause")},onresume:function(){a.trigger("resume")}})},destruct:function(){this.stream&&this.stream.destruct(),this.trigger("destruct"),this.set({selected:!1})}}),b=Backbone.Collection.extend({model:c,select:function(a){var b;typeof a=="number"&&_.each(this.models,function(b,c,d){+b.id==a&&h.router.navigate("tracks/"+this.models[c].id,!0)}),a==="next"&&(b=this.models.indexOf(this.currentTrack),b>-1&&b<=this.models.length-2&&(b+=1,h.router.navigate("tracks/"+this.models[b].id,!0))),a==="previous"&&(b=this.models.indexOf(this.currentTrack),b>0&&(b-=1,h.router.navigate("tracks/"+this.models[b].id,!0)))}}),d=Backbone.View.extend({render:function(){this.rendered=!0;var a=this;return $(this.el).append(a.template(a.model.toJSON())),this},events:{"click .previous":"previous","click .play":"play","click .next":"next","touchstart .previous":"previous","touchstart .play":"play","touchstart .next":"next"},updateControl:function(){this.status==="paused"?this.$(".play").removeClass("pause"):this.$(".play").addClass("pause")},updateTime:function(){var a=this.model.stream,b=this;a.playState===1&&!a.paused&&(this.$(".track-current").html(b.formatTime(b.model.stream.position)),setTimeout(_.bind(b.updateTime,b),900))},play:function(a){a.preventDefault();var b=this.model;switch(this.status){case"playing":this.status="paused",b.pause(),this.updateControl();break;case"paused":this.status="resumed",b.pause(),this.updateControl();break;case"resumed":this.status="playing",b.pause(),this.updateControl();break;default:b.play(),this.updateControl()}},previous:function(a){a.preventDefault(),this.model.collection.select("previous")},next:function(a){a.preventDefault(),this.model.collection.select("next")},formatTime:function(a){var b=Math.floor(a/1e3),c=Math.floor(b/60);return b=b%60<10?"0"+b%60:b%60,c=c<60?"0"+c:c,c+":"+b},template:Templates.Controls,className:"controls",tagName:"div",model:c,initialize:function(){var a=this,b=this.model;this.rendered=!1,this.status=null,b.bind("play",function(){a.$(".track-duration").html(a.formatTime(a.model.get("duration"))),a.status="playing",a.updateControl(),a.updateTime()}),b.bind("pause",function(){a.status="paused",a.updateControl()}),b.bind("resume",function(){a.status="resumed",a.updateControl(),a.updateTime()})}}),f=Backbone.View.extend({className:"scrubber",tagName:"div",model:c,initialize:function(){var a=this;this.model.bind("play",function(){a.position()}),this.model.bind("pause",function(){a.pause()}),this.model.bind("resume",function(){a.position()})},position:function(){var a=this,b=a.model.stream,c=a.model.attributes.duration,d=b.position||0;this.$(".scrubber-knob").css({"-webkit-transform":"translate3d("+d/c*100+"%,0,0)","-webkit-transition-duration":"0s"}),setTimeout(function(){a.$(".scrubber-knob").css({"-webkit-transform":"translate3d(100%, 0px, 0)","-webkit-transition-duration":(c-d)/1e3+"s"})},1)},pause:function(){var a=this.model.stream,b=a.position,c=this.model.attributes.duration;this.$(".scrubber-knob").css({"-webkit-transform":"translate3d("+b/c*100+"%,0,0)","-webkit-transition-duration":"0s"})},render:function(){var a=this,b=this.model;return $(this.el).html(a.template(b.toJSON())),$(this.el).bind("touchstart",function(b){b.preventDefault(),a.pause()}),$(this.el).bind("touchmove",function(b){b.preventDefault(),a.$(".scrubber-knob").css({"-webkit-transform":"translate3d("+b.touches[0].clientX+"px,0,0)"})}),$(this.el).bind("touchend",function(b){var c=b.changedTouches[0].clientX,d=window.innerWidth,e=a.model.attributes.duration,f=Math.round(c*e/d);b.preventDefault(),a.model.stream.setPosition(f),a.position()}),this},template:Templates.Scrubber}),m=Backbone.View.extend({className:"app-header",tagName:"header",initialize:function(){this.render()},render:function(){var a=this;return $(a.el).append(a.template()),this},update:function(a){var b=a.title||"",c=a.headerRight||"";this.$(".header-title").html(b),this.$(".header-right").html(c)},template:_.template('<div class="header-left"></div><h1 class="header-title"></h1><div class="header-right"></div>')}),e=Backbone.View.extend({className:"track",tagName:"div",initialize:function(){this.rendered=!1;var a=this;this.model.bind("change",function(){a.mark()}),this.model.get("loaded")?this.render():(this.throbber(),this.model.bind("loaded",function(){a.render()}))},throbber:function(){return $(this.el).append("<div>LOADING ...</div>"),this},template:Templates.TrackView,mark:function(){var a=this;a.model.get("selected")?$(a.el).addClass("selected"):$(a.el).removeClass("selected")},render:function(){var a=this;return this.rendered=!0,$(this.el).html(this.template(this.model.toJSON())),$(this.el)[p?"tap":"click"](function(b){h.router.navigate("tracks/"+a.model.id,!0),$(a.el).unbind(p?"touchstart":"click")}),a.mark(),this},model:c}),k=Backbone.View.extend({title:"&#9729;",id:"home",tagName:"div",collection:b,initialize:function(){this.rendered=!1},render:function(){this.rendered=!0;var a=h.currentScreen();a.id="tracks";var b,d=this;return _.each(d.collection.models,function(a){b=new e({model:new c(a)}),b.el.className="track",d.el.appendChild(b.el)}),this}}),l=Backbone.View.extend({className:"track-detail",tagName:"div",headerRight:function(){var a=$('<a class="icon" href="#">\u266b</a>').bind("click",function(){h.router.navigate("",!0)});return a},initialize:function(){var a=this;this.rendered=!1,this.scrubber=new f({model:this.model}),this.controls=new d({model:this.model}),this.meta=new TrackMeta({model:this.model}),this.model.get("loaded")?this.renderSubViews():this.model.bind("loaded",function(){a.renderSubViews(),h.header.update(a)})},renderSubViews:function(){this.scrubber.render(),this.controls.render(),this.meta.render(),this.title=""+this.model.get("title").slice(0,16).concat(" ...")},throbber:function(){$(this.el).html("<div>LOADING</div>")},render:function(){return this.rendered=!0,$(this.scrubber.el).appendTo(this.el),$(this.controls.el).appendTo(this.el),$(this.meta.el).appendTo(this.el),this.model.get("comment_count")>0&&(this.comments=new n({model:this.model}),this.comments.render(),$(this.comments.el).appendTo(this.el)),h.settings.autoplay&&this.model.play(),this},model:c}),TrackMeta=Backbone.View.extend({className:"track-meta",tagName:"div",initialize:function(){this.rendered=!1},render:function(){this.rendered=!0;var a=this;return $(this.el).append(this.template(this.model.toJSON())),this.model.get("artwork_url")||this.$(".meta-image").html('<div class="meta-placeholder"></div>'),$(this.el).swipeLeft(function(){a.model.collection.select("next")}),$(this.el).swipeRight(function(){a.model.collection.select("previous")}),this},template:Templates.TrackMeta,model:c}),n=Backbone.View.extend({className:"track-comments",tagName:"div",model:c,initialize:function(){this.offset=0,this.limit=20},render:function(){var a=this;return $(a.el).append(a.template()),this},events:{"click .load-comments":"load"},load:function(a){var b=this;a.preventDefault(),$(b.el).append('<div id="track-'+b.model.id+'-comments" class="loading">Loading ... </div>');var b=this;SC.get("/tracks/"+b.model.id+"/comments",{limit:20,offset:b.offset},function(a,c){var d=$("#track-"+b.model.id+"-comments")[0];$("#track-"+b.model.id+"-comments")[0].parentNode.removeChild(d),c&&alert("ERROR: ",c),b.offset+=b.limit,b.update(a)})},update:function(a){var b=this;this.offset>=b.model.get("comment_count")?$(".load-comments").hide():$(".load-comments").html("Load More Comments");var c=_.template('<div id="comment-<%= id %>" class="comment"><p><%= body %></p><div class="comment-meta"><%= user.username %><img src="<%= user.avatar_url %>" width="20" height="20" /></div></div>');_.each(a,function(a){$(".load-comments").before(c(a))})},template:_.template('<a href="javascript: void(0)" class="load-comments">Load Comments</a>')}),a.init=function(){h=new g,h.router=new i,Backbone.history.start({root:"/soundbone/"})}})()